name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (for example v0.3.0)"
        required: false

permissions:
  contents: write

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      CI: true
      PLENARY_RTP: ${{ github.workspace }}/.ci/plenary.nvim

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v11
        with:
          luaVersion: "5.1"

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v5

      - name: Install luacheck
        run: luarocks install luacheck

      - name: Setup StyLua
        uses: JohnnyMorganz/stylua-action@v4
        with:
          version: latest
          token: ${{ secrets.GITHUB_TOKEN }}
          args: lua

      - name: Setup Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - name: Install plenary.nvim
        run: |
          mkdir -p "$(dirname "$PLENARY_RTP")"
          git clone --depth 1 https://github.com/nvim-lua/plenary.nvim "$PLENARY_RTP"

      - name: Run verify
        run: make verify

      - name: Resolve version tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi

          if [[ -z "$VERSION" ]]; then
            echo "Version is required for release" >&2
            exit 1
          fi

          if [[ "$VERSION" != v* ]]; then
            VERSION="v$VERSION"
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid version tag: $VERSION" >&2
            exit 1
          fi

          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build release assets
        run: |
          VERSION="${{ steps.version.outputs.value }}"
          mkdir -p dist
          cp lua/theme-browser/data/registry.json dist/themes.json

          THEMES_SHA256="$(sha256sum dist/themes.json | cut -d' ' -f1)"
          GENERATED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          THEMES_SIZE="$(wc -c < dist/themes.json | tr -d ' ')"

          cat > dist/manifest.json <<EOF
          {
            "version": "${VERSION}",
            "generated_at": "${GENERATED_AT}",
            "sha256": "${THEMES_SHA256}",
            "themes_file": "themes.json",
            "themes_size_bytes": ${THEMES_SIZE},
            "schema": "theme-browser-registry-v1"
          }
          EOF

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.value }}"
          VERSION_NO_V="${VERSION#v}"
          NOTES_FILE=".github/release-notes.md"

          mkdir -p .github

          awk -v version="$VERSION_NO_V" '
            BEGIN {
              in_section = 0
              found = 0
            }
            $0 ~ "^## \\[" version "\\]" {
              in_section = 1
              found = 1
              next
            }
            in_section && $0 ~ "^## \\[" {
              exit
            }
            in_section {
              print
            }
            END {
              if (found == 0) {
                exit 2
              }
            }
          ' CHANGELOG.md > "$NOTES_FILE" || true

          if [[ ! -s "$NOTES_FILE" ]]; then
            printf '%s\n\n%s\n%s\n' \
              "No changelog entry found for the requested version." \
              "Please add a matching section to CHANGELOG.md using:" \
              "## [X.Y.Z] - YYYY-MM-DD" > "$NOTES_FILE"
          fi

          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "Release $VERSION already exists, updating title and notes"
            gh release edit "$VERSION" --title "$VERSION" --notes-file "$NOTES_FILE"
          else
            echo "Creating release $VERSION"
            gh release create "$VERSION" \
              --title "$VERSION" \
              --notes-file "$NOTES_FILE"
          fi

          gh release upload "$VERSION" \
            "dist/themes.json" \
            "dist/manifest.json" \
            --clobber

      - name: Validate release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.value }}"
          expected=(
            "themes.json"
            "manifest.json"
          )

          for name in "${expected[@]}"; do
            size=$(gh release view "$VERSION" --json assets --jq ".assets[] | select(.name == \"$name\") | .size")
            if [[ -z "$size" || "$size" -le 0 ]]; then
              echo "Missing or empty release asset: $name" >&2
              exit 1
            fi
            echo "Validated release asset: $name (${size} bytes)"
          done
